# 功能规范：数据库查询工具

**功能分支**: `001-db-query-tool`
**创建日期**: 2025-12-13
**状态**: 草稿
**输入**: 用户描述: "数据库查询工具，支持添加数据库连接、查看元数据、执行 SQL 查询和自然语言生成 SQL"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 连接数据库并查看结构 (优先级: P1)

作为用户，我希望能够添加一个数据库连接 URL，系统会自动连接数据库并展示所有表和视图的结构信息，以便我了解数据库中有哪些数据可用。

**优先级说明**: 这是最基础的功能——没有数据库连接和元数据展示，其他功能都无法工作。用户必须先看到数据库结构才能进行查询。

**独立测试**: 可以通过提供一个有效的 PostgreSQL 连接 URL 来完整测试，验证系统能够展示数据库的表和视图及其列信息。这个功能独立交付就能让用户了解数据库结构。

**验收场景**:

1. **假设** 用户在主界面上，**当** 用户输入一个有效的 PostgreSQL 连接 URL 并提交，**那么** 系统连接数据库、提取元数据（表、视图、列、类型）、存储到本地 SQLite 数据库，并展示可浏览的结构树。

2. **假设** 用户之前已添加过数据库连接，**当** 用户再次打开应用，**那么** 可以看到之前保存的数据库连接及其缓存的元数据。

3. **假设** 用户输入了无效或无法访问的连接 URL，**当** 用户提交时，**那么** 系统显示清晰的错误信息说明连接失败的原因（如 "连接失败：认证错误" 或 "主机无法访问"）。

4. **假设** 数据库已连接，**当** 用户选择某个表或视图，**那么** 可以看到列名、数据类型和约束信息（主键、外键、是否可空）。

---

### 用户故事 2 - 手动执行 SQL 查询 (优先级: P2)

作为用户，我希望能够编写并执行 SQL SELECT 查询，并以表格形式查看结果，以便探索和分析数据。

**优先级说明**: SQL 查询是工具的核心功能。熟悉 SQL 的用户需要这个能力来探索和分析数据。这为高级用户提供即时价值，而自然语言生成（P3）则服务于需要帮助的用户。

**独立测试**: 可以通过在输入区域编写 SELECT 查询并验证结果以表格形式显示来完整测试。独立交付即可用于数据探索。

**验收场景**:

1. **假设** 数据库已连接，**当** 用户输入一个有效的 SELECT 查询并执行，**那么** 结果以表格形式显示，包含列标题。

2. **假设** 用户输入的查询没有 LIMIT 子句，**当** 执行时，**那么** 系统自动添加 LIMIT 1000 以防止返回过多数据。

3. **假设** 用户输入的查询有语法错误，**当** 执行时，**那么** 系统在发送到数据库之前显示有帮助的错误信息，指出语法问题。

4. **假设** 用户输入了非 SELECT 语句（INSERT、UPDATE、DELETE、DROP 等），**当** 尝试执行时，**那么** 系统阻止查询并显示错误："只允许执行 SELECT 查询"。

5. **假设** SELECT 查询执行成功，**当** 返回结果时，**那么** 数据以 JSON 格式返回并在前端渲染为可交互的表格。

---

### 用户故事 2.1 - 导出查询结果 (优先级: P2)

作为用户，我希望能够将查询结果导出为 CSV 或 JSON 格式文件，以便在其他工具中进一步分析或存档。

**优先级说明**: 这是 SQL 查询功能（P2）的自然延伸。用户在查看查询结果后，常常需要将数据导出用于报告、分析或与他人分享。

**独立测试**: 可以通过执行一个查询后点击导出按钮，验证文件成功下载且内容正确来完整测试。

**验收场景**:

1. **假设** 查询已成功执行并显示结果，**当** 用户点击"导出 CSV"按钮，**那么** 浏览器自动下载一个 CSV 文件，文件名格式为 `query_result_YYYYMMDD_HHMMSS.csv`，内容为当前显示的所有数据行。

2. **假设** 查询已成功执行并显示结果，**当** 用户点击"导出 JSON"按钮，**那么** 浏览器自动下载一个 JSON 文件，文件名格式为 `query_result_YYYYMMDD_HHMMSS.json`，内容为数组格式的查询结果。

3. **假设** 查询结果包含中文字符，**当** 用户导出为 CSV 并用 Excel 打开，**那么** 中文字符正确显示（UTF-8 with BOM 编码）。

4. **假设** 查询尚未执行或无结果，**当** 用户查看界面，**那么** 导出按钮不可用或不显示。

---

### 用户故事 3 - 自然语言生成 SQL (优先级: P3)

作为用户，我希望能够用自然语言描述我需要的数据，系统为我生成 SQL 查询，我可以审查、编辑后执行。

**优先级说明**: 自然语言查询生成扩展了工具的适用范围，让不熟悉 SQL 的用户也能使用。它依赖于元数据（P1）作为 LLM 的上下文，以及查询执行能力（P2）来运行生成的查询。

**独立测试**: 可以通过输入自然语言描述（如 "显示上个月注册的所有用户"）并验证生成了有效的 SQL 查询来完整测试。独立交付可降低 SQL 知识门槛。

**验收场景**:

1. **假设** 数据库已连接且有缓存的元数据，**当** 用户输入自然语言查询描述（如 "显示上周的所有订单及客户名称"），**那么** 系统将请求连同表/视图元数据作为上下文发送给 LLM，并返回生成的 SQL 查询。

2. **假设** LLM 生成的 SQL 查询已显示，**当** 用户查看时，**那么** 可以在执行前编辑查询。

3. **假设** LLM 生成的 SQL 查询已显示，**当** 用户点击 "执行"，**那么** 查询经过与手动输入查询相同的验证（语法检查、仅 SELECT、自动添加 LIMIT）。

4. **假设** LLM 无法根据描述生成有效查询，**当** 发生这种情况时，**那么** 系统显示消息请用户重新描述或提供更多细节。

---

### 边界情况

- **空数据库**: 当连接的数据库没有表或视图时，显示消息："该数据库中没有找到表或视图"。
- **大结果集**: 即使有 LIMIT 1000，结果可能仍然很大。前端应优雅地处理分页或滚动。
- **连接超时**: 如果在查询执行过程中数据库变得不可访问，显示超时错误并建议检查连接。
- **数据中的特殊字符**: 确保在显示包含特殊字符、HTML 或 JSON 字符串的数据时正确转义/编码。
- **多个连接**: 如果用户添加多个数据库连接，确保每个连接的元数据和查询正确隔离。
- **结构变更**: 如果数据库结构在元数据缓存后发生变化，提供刷新/重新同步元数据的方式。
- **LLM 不可用**: 如果 LLM 服务不可用，显示错误并允许用户手动编写 SQL。
- **导出空结果**: 当查询结果为空（0 行）时，导出按钮应禁用。
- **CSV 特殊字符**: 导出 CSV 时，包含逗号、换行符或双引号的字段值需正确转义（用双引号包裹，内部双引号转义为两个双引号）。

## 需求 *(必填)*

### 功能需求

**数据库连接管理**
- **FR-001**: 系统必须接受标准格式的 PostgreSQL 连接 URL（postgresql://user:pass@host:port/dbname）
- **FR-002**: 系统必须在尝试连接前验证连接 URL 格式
- **FR-003**: 系统必须将连接配置持久化存储到本地 SQLite 数据库
- **FR-004**: 系统必须支持每个用户会话管理多个数据库连接

**元数据提取**
- **FR-005**: 系统必须从连接的数据库中提取表和视图名称
- **FR-006**: 系统必须提取每个表/视图的列名、数据类型和约束信息
- **FR-007**: 系统必须将提取的元数据缓存到本地 SQLite 数据库以便复用
- **FR-008**: 系统必须提供按需刷新缓存元数据的机制

**SQL 查询执行**
- **FR-009**: 系统必须使用 SQL 解析器在执行前解析所有 SQL 查询
- **FR-010**: 系统必须拒绝任何非 SELECT 语句的查询
- **FR-011**: 系统必须为没有 LIMIT 子句的查询自动添加 LIMIT 1000
- **FR-012**: 系统必须以 JSON 格式返回查询结果
- **FR-013**: 系统必须在查询解析失败时显示有帮助的语法错误信息

**自然语言转 SQL**
- **FR-014**: 系统必须在生成 SQL 时将数据库元数据（表、列、类型）作为上下文发送给 LLM
- **FR-015**: 系统必须在执行前展示生成的 SQL 供用户审查
- **FR-016**: 系统必须允许用户在执行前编辑生成的 SQL
- **FR-017**: 生成的 SQL 必须经过与手动输入查询相同的验证

**用户界面**
- **FR-018**: 系统必须以可浏览的层级格式展示数据库结构
- **FR-019**: 系统必须以表格形式展示查询结果，包含列标题
- **FR-020**: 系统必须为所有失败场景提供清晰的错误信息

**查询结果导出**
- **FR-021**: 系统必须在查询结果显示后提供导出按钮
- **FR-022**: 系统必须支持导出为 CSV 格式文件
- **FR-023**: 系统必须支持导出为 JSON 格式文件
- **FR-024**: 导出范围为当前显示的查询结果（最多 1000 行）
- **FR-025**: 导出文件通过浏览器直接下载，文件名自动生成（格式：query_result_YYYYMMDD_HHMMSS.csv/json）
- **FR-026**: CSV 文件使用 UTF-8 with BOM 编码（确保 Excel 正确显示中文）
- **FR-027**: JSON 文件使用简单数组格式 `[{col1: val1, col2: val2}, ...]`

### 关键实体

- **数据库连接 (DatabaseConnection)**: 表示保存的数据库连接，包含连接 URL（明文存储，仅供本地使用）、显示名称和最后连接时间戳
- **数据库元数据 (DatabaseMetadata)**: 表示缓存的结构信息，包括表、视图及其列的类型和约束
- **表/视图 (Table/View)**: 表示数据库表或视图，包含名称、模式和列列表
- **列 (Column)**: 表示表/视图的列，包含名称、数据类型、是否可空和约束信息
- **查询 (Query)**: 表示 SQL 查询，包含查询文本、执行时间戳和关联的连接
- **查询结果 (QueryResult)**: 表示查询执行的结果，包含列标题和行数据

### 假设

- PostgreSQL 是首要（且最初唯一）支持的数据库类型
- 用户拥有有效的 PostgreSQL 凭据和数据库网络访问权限
- 本地 SQLite 数据库存储在标准应用数据目录
- LLM 集成使用 OpenAI 兼容 API（支持 OpenAI、Azure OpenAI、本地模型如 Ollama 等）
- 默认最大查询结果为 1000 行（可减少，不可增加）
- 应用采用 Web 架构（前后端分离），通过浏览器访问
- 查询结果导出在前端实现（JavaScript 直接处理内存中的数据，无需后端接口）

## 澄清记录

### 会话 2025-12-13

- Q: 数据库凭据存储方式？ → A: 明文存储（仅本地使用，信任本机安全）
- Q: LLM 服务提供商？ → A: OpenAI 兼容 API（支持 OpenAI、Azure、本地模型等）
- Q: 应用部署形态？ → A: Web 应用（前后端分离，浏览器访问）

### 会话 2025-12-14

- Q: 导出的数据范围是什么？ → A: 导出当前显示结果（最多 1000 行）
- Q: 导出文件的下载方式？ → A: 浏览器直接下载（自动命名）
- Q: CSV 导出时的编码格式？ → A: UTF-8 with BOM（Excel 兼容）
- Q: 导出功能在哪一层实现？ → A: 前端生成（JavaScript 直接转换内存中的数据）
- Q: JSON 导出的数据结构格式？ → A: 简单数组 `[{col1: val1, col2: val2}, ...]`

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户在提供有效 URL 后 30 秒内可以添加数据库连接并查看其结构
- **SC-002**: 100% 的非 SELECT 查询在到达数据库之前被阻止
- **SC-003**: 典型查询（1000 行以下）的结果在 5 秒内显示
- **SC-004**: 自然语言查询对 80% 的常见数据探索请求能生成有效 SQL
- **SC-005**: 用户在添加数据库连接后 2 分钟内可以成功执行第一个查询
- **SC-006**: 所有错误场景都产生用户友好的消息（不向用户显示原始堆栈跟踪或技术错误）
- **SC-007**: 缓存的元数据在应用重启后持久保存，无需重新连接
- **SC-008**: 用户反馈结构浏览器帮助他们理解可用数据（定性反馈目标：4/5 满意度）
- **SC-009**: 查询结果导出在 2 秒内完成下载（1000 行以内数据）
- **SC-010**: 导出的 CSV 文件在 Excel 中打开时中文字符正确显示
