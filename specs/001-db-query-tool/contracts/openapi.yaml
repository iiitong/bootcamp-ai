openapi: 3.1.0
info:
  title: DB Query Tool API
  description: |
    REST API for managing database connections, executing SQL queries,
    and generating SQL from natural language.
  version: 1.0.0
  contact:
    name: DB Query Tool

servers:
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: databases
    description: Database connection management
  - name: queries
    description: SQL query execution
  - name: natural
    description: Natural language to SQL

paths:
  /api/v1/dbs:
    get:
      tags: [databases]
      summary: List all database connections
      description: Returns all stored database connections with masked URLs
      operationId: listDatabases
      responses:
        '200':
          description: List of database connections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DatabaseConnection'

  /api/v1/dbs/{name}:
    put:
      tags: [databases]
      summary: Add or update a database connection
      description: |
        Creates a new database connection or updates an existing one.
        On creation, the system connects to the database and extracts metadata.
      operationId: upsertDatabase
      parameters:
        - $ref: '#/components/parameters/DatabaseName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DatabaseConnectionCreate'
      responses:
        '200':
          description: Database connection created/updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseMetadata'
        '400':
          description: Invalid connection URL or connection failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [databases]
      summary: Get database metadata
      description: Returns the cached metadata for a database connection
      operationId: getDatabaseMetadata
      parameters:
        - $ref: '#/components/parameters/DatabaseName'
      responses:
        '200':
          description: Database metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseMetadata'
        '404':
          description: Database connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [databases]
      summary: Delete a database connection
      description: Removes a database connection and its cached metadata
      operationId: deleteDatabase
      parameters:
        - $ref: '#/components/parameters/DatabaseName'
      responses:
        '204':
          description: Database connection deleted successfully
        '404':
          description: Database connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/dbs/{name}/refresh:
    post:
      tags: [databases]
      summary: Refresh database metadata
      description: Re-extracts metadata from the database (useful after schema changes)
      operationId: refreshMetadata
      parameters:
        - $ref: '#/components/parameters/DatabaseName'
      responses:
        '200':
          description: Metadata refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseMetadata'
        '404':
          description: Database connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/dbs/{name}/query:
    post:
      tags: [queries]
      summary: Execute SQL query
      description: |
        Executes a SQL query against the specified database.
        - Only SELECT statements are allowed
        - LIMIT 1000 is auto-applied if not specified
        - SQL is validated before execution
      operationId: executeQuery
      parameters:
        - $ref: '#/components/parameters/DatabaseName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Query executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResult'
        '400':
          description: SQL validation error (syntax or non-SELECT)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryError'
        '404':
          description: Database connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Query execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryError'

  /api/v1/dbs/{name}/query/natural:
    post:
      tags: [natural]
      summary: Generate SQL from natural language
      description: |
        Uses LLM to generate a SQL query from natural language description.
        The database schema is provided as context to the LLM.
        Generated SQL is returned for user review before execution.
      operationId: generateNaturalQuery
      parameters:
        - $ref: '#/components/parameters/DatabaseName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NaturalQueryRequest'
      responses:
        '200':
          description: SQL generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneratedSQL'
        '400':
          description: Invalid prompt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Database connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: LLM service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  parameters:
    DatabaseName:
      name: name
      in: path
      required: true
      description: Unique name for the database connection
      schema:
        type: string
        pattern: '^[a-zA-Z][a-zA-Z0-9_-]*$'
        minLength: 1
        maxLength: 64
      example: my_postgres

  schemas:
    # Request schemas
    DatabaseConnectionCreate:
      type: object
      required: [url]
      properties:
        url:
          type: string
          format: uri
          description: PostgreSQL connection URL
          example: postgresql://user:password@localhost:5432/mydb

    QueryRequest:
      type: object
      required: [sql]
      properties:
        sql:
          type: string
          description: SQL SELECT query to execute
          minLength: 1
          maxLength: 10000
          example: SELECT * FROM users WHERE active = true

    NaturalQueryRequest:
      type: object
      required: [prompt]
      properties:
        prompt:
          type: string
          description: Natural language description of the desired query
          minLength: 1
          maxLength: 1000
          example: 查询用户表的所有信息

    # Response schemas
    DatabaseConnection:
      type: object
      required: [name, urlMasked, createdAt]
      properties:
        name:
          type: string
          description: Unique identifier for the connection
          example: my_postgres
        urlMasked:
          type: string
          description: Connection URL with password masked
          example: postgresql://user:***@localhost:5432/mydb
        createdAt:
          type: string
          format: date-time
          description: When the connection was created
        lastConnectedAt:
          type: string
          format: date-time
          nullable: true
          description: When the connection was last used

    ColumnInfo:
      type: object
      required: [name, dataType, isNullable, isPrimaryKey, isForeignKey]
      properties:
        name:
          type: string
          example: user_id
        dataType:
          type: string
          description: PostgreSQL data type
          example: integer
        isNullable:
          type: boolean
        isPrimaryKey:
          type: boolean
        isForeignKey:
          type: boolean
        defaultValue:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
          description: Column comment if available

    TableInfo:
      type: object
      required: [name, schemaName, tableType, columns]
      properties:
        name:
          type: string
          example: users
        schemaName:
          type: string
          example: public
        tableType:
          type: string
          enum: [table, view]
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ColumnInfo'
        rowCountEstimate:
          type: integer
          nullable: true
          description: Estimated row count from pg_stat_user_tables

    DatabaseMetadata:
      type: object
      required: [databaseName, tables, views, extractedAt]
      properties:
        databaseName:
          type: string
          example: my_postgres
        tables:
          type: array
          items:
            $ref: '#/components/schemas/TableInfo'
        views:
          type: array
          items:
            $ref: '#/components/schemas/TableInfo'
        extractedAt:
          type: string
          format: date-time

    QueryResult:
      type: object
      required: [columns, rows, rowCount, executionTimeMs, truncated]
      properties:
        columns:
          type: array
          items:
            type: string
          description: Column names in result order
          example: [id, name, email]
        rows:
          type: array
          items:
            type: object
            additionalProperties: true
          description: Result rows as objects with camelCase keys
        rowCount:
          type: integer
          description: Number of rows returned
        executionTimeMs:
          type: number
          format: float
          description: Query execution time in milliseconds
        truncated:
          type: boolean
          description: True if LIMIT was auto-applied

    GeneratedSQL:
      type: object
      required: [sql]
      properties:
        sql:
          type: string
          description: Generated SQL query
          example: SELECT * FROM users
        explanation:
          type: string
          nullable: true
          description: Optional explanation of the generated query
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          nullable: true
          description: Confidence score (0.0-1.0)

    # Error schemas
    QueryError:
      type: object
      required: [error, errorType]
      properties:
        error:
          type: string
          description: Human-readable error message
        errorType:
          type: string
          enum: [syntax_error, validation_error, execution_error]
        details:
          type: string
          nullable: true
          description: Additional error details

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Human-readable error message
        details:
          type: string
          nullable: true
