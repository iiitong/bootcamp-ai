# 功能规格说明：MySQL 数据库支持

**功能分支**: `002-mysql-support`
**创建日期**: 2025-12-16
**状态**: 草稿
**输入**: 用户描述: "参考 ./w2/db_query/backend 中的 PostgreSQL 实现，实现 MySQL 的 metadata 提取和查询支持，同时自然语言生成 sql 也支持 MySQL。另外需要生成一个生成测试数据库和测试数据的文件来进行 mysql 连接、查询的测试，测试 DB 要包含不少于 5 张表，至少一张表要有大于 1000 条的测试数据，使用 mysql -u root 可以访问到我的数据库。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 添加 MySQL 数据库连接 (优先级: P1)

作为数据分析师，我希望能够添加和管理 MySQL 数据库连接，这样我就可以查询 MySQL 数据库中的数据。

**优先级原因**: 这是使用 MySQL 功能的前提条件，没有连接管理就无法使用任何其他功能。

**独立测试**: 可以通过添加一个 MySQL 连接、验证连接成功、查看连接列表来完全测试。此功能独立提供价值——用户可以管理他们的数据库连接。

**验收场景**:

1. **假设** 用户在连接管理页面，**当** 用户输入有效的 MySQL 连接 URL (mysql://root@localhost:3306/testdb) 并提交，**则** 系统成功建立连接并保存连接信息
2. **假设** 用户已添加 MySQL 连接，**当** 用户查看连接列表，**则** 系统显示该连接信息且密码被掩码处理
3. **假设** 用户输入无效的 MySQL 连接 URL，**当** 用户提交连接请求，**则** 系统返回清晰的错误提示，说明连接失败原因
4. **假设** 用户已添加 MySQL 连接，**当** 用户删除该连接，**则** 系统删除连接和所有相关的缓存元数据

---

### 用户故事 2 - 提取 MySQL 数据库元数据 (优先级: P1)

作为数据分析师，我希望系统能自动提取 MySQL 数据库的结构信息（表、视图、列、主键、外键等），这样我可以了解数据库结构并编写查询。

**优先级原因**: 元数据提取是查询和自然语言生成 SQL 的基础，用户需要了解数据库结构才能有效使用系统。

**独立测试**: 可以通过添加 MySQL 连接后查看完整的数据库结构来测试。用户可以浏览所有表、视图及其列定义。

**验收场景**:

1. **假设** 用户成功添加 MySQL 连接，**当** 连接建立后，**则** 系统自动提取并缓存数据库的表、视图、列信息
2. **假设** 数据库包含多个表和视图，**当** 用户查看数据库元数据，**则** 系统显示完整的结构信息，包括：表名、列名、数据类型、是否可空、默认值、主键标识、外键标识
3. **假设** 用户已获取元数据，**当** 用户请求刷新元数据，**则** 系统重新从数据库提取最新结构并更新缓存
4. **假设** MySQL 数据库为空（无表无视图），**当** 用户查看元数据，**则** 系统正确显示空数据库状态

---

### 用户故事 3 - 执行 MySQL 查询 (优先级: P1)

作为数据分析师，我希望能够对 MySQL 数据库执行 SQL 查询并查看结果，这样我可以分析数据库中的数据。

**优先级原因**: 查询执行是系统的核心功能，用户添加连接的最终目的是为了查询数据。

**独立测试**: 可以通过在已连接的 MySQL 数据库上执行各种 SELECT 查询并验证结果来测试。

**验收场景**:

1. **假设** 用户已添加 MySQL 连接，**当** 用户输入有效的 SELECT 查询并执行，**则** 系统返回查询结果，包括列名、数据行、行数和执行时间
2. **假设** 用户输入不带 LIMIT 的 SELECT 查询，**当** 执行查询，**则** 系统自动添加 LIMIT 限制（默认 1000）以防止返回过多数据
3. **假设** 用户尝试执行 INSERT/UPDATE/DELETE 等非 SELECT 语句，**当** 提交查询，**则** 系统拒绝执行并返回错误提示，说明仅支持 SELECT 查询
4. **假设** 查询执行时间超过超时限制，**当** 超时发生，**则** 系统终止查询并返回超时错误
5. **假设** 用户输入语法错误的 SQL，**当** 执行查询，**则** 系统返回清晰的语法错误信息

---

### 用户故事 4 - 自然语言生成 MySQL 查询 (优先级: P2)

作为数据分析师，我希望用自然语言描述我想查询的数据，系统能自动生成对应的 MySQL SQL 语句，这样即使我不熟悉 SQL 语法也能查询数据。

**优先级原因**: 自然语言查询降低了使用门槛，但依赖于连接管理和查询执行功能，因此优先级稍低。

**独立测试**: 可以通过输入自然语言描述，验证系统是否生成正确的 MySQL 语法的 SQL 查询来测试。

**验收场景**:

1. **假设** 用户已连接 MySQL 数据库且元数据已缓存，**当** 用户用自然语言描述查询需求（如"查询所有用户的姓名和邮箱"），**则** 系统生成对应的 MySQL SELECT 语句
2. **假设** 自然语言描述涉及多表关联，**当** 生成查询，**则** 系统生成正确的 JOIN 语句
3. **假设** 生成的 SQL 需要使用 MySQL 特有语法，**当** 生成查询，**则** 系统使用 MySQL 兼容的语法（如 LIMIT 而非 TOP，反引号引用标识符）
4. **假设** 自然语言描述模糊不清，**当** 生成查询，**则** 系统基于数据库结构做出合理推断并生成查询

---

### 用户故事 5 - 测试数据库设置 (优先级: P2)

作为开发者，我希望有一个脚本可以创建用于测试的 MySQL 数据库和测试数据，这样我可以验证 MySQL 支持功能的正确性。

**优先级原因**: 测试数据库对于验证功能实现至关重要，但它是开发/测试工具而非最终用户功能。

**独立测试**: 可以通过运行脚本、验证数据库和数据创建成功来测试。

**验收场景**:

1. **假设** MySQL 服务正在运行且可通过 `mysql -u root` 访问，**当** 运行测试数据生成脚本，**则** 系统创建包含至少 5 张表的测试数据库
2. **假设** 测试数据库创建成功，**当** 检查数据，**则** 至少有一张表包含超过 1000 条测试数据
3. **假设** 测试数据库已存在，**当** 重新运行脚本，**则** 系统重置数据库到初始状态（删除重建或清空重新插入）
4. **假设** 脚本执行过程中发生错误，**当** 错误发生，**则** 系统提供清晰的错误信息帮助诊断问题

---

### 边缘情况

- 当 MySQL 服务器不可达时会发生什么？→ 系统返回连接超时或连接被拒绝的错误信息
- 当用户凭据无效时系统如何处理？→ 系统返回认证失败的错误信息
- 当查询结果包含二进制数据或特殊字符时如何处理？→ 系统正确序列化数据，二进制数据以合适的格式显示
- 当数据库字符集不是 UTF-8 时如何处理？→ 系统尝试正确转换字符集，如失败则提示用户
- 当表名或列名包含 MySQL 关键字时如何处理？→ 系统在生成的 SQL 中使用反引号正确转义标识符
- 当用户同时添加 PostgreSQL 和 MySQL 连接时如何区分？→ 系统根据连接 URL 前缀（mysql:// vs postgresql://）自动识别数据库类型

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须支持 MySQL 连接 URL 格式 (mysql://user:password@host:port/database)
- **FR-002**: 系统必须能够从 MySQL 的 information_schema 提取数据库元数据
- **FR-003**: 系统必须提取并缓存表信息，包括：schema 名称、表名、表类型（TABLE/VIEW）
- **FR-004**: 系统必须提取并缓存列信息，包括：列名、数据类型、是否可空、默认值、是否主键、是否外键
- **FR-005**: 系统必须验证 MySQL 查询语法，仅允许 SELECT 和 UNION 查询
- **FR-006**: 系统必须为无 LIMIT 的 SELECT 查询自动添加 LIMIT 限制
- **FR-007**: 系统必须支持 MySQL 查询执行，包括超时控制
- **FR-008**: 系统必须在返回连接信息时对密码进行掩码处理
- **FR-009**: 自然语言到 SQL 生成必须使用 MySQL 兼容的语法
- **FR-010**: 系统必须提供测试数据库创建脚本，创建至少 5 张表
- **FR-011**: 测试数据库必须包含至少一张有超过 1000 条记录的表
- **FR-012**: 系统必须能够区分和同时管理 PostgreSQL 和 MySQL 连接
- **FR-013**: 系统必须在 SQL 处理时使用 MySQL 方言（使用 sqlglot 的 MySQL 方言）

### 关键实体

- **数据库连接 (DatabaseConnection)**: 表示一个 MySQL 数据库连接，包含名称、连接 URL、数据库类型、创建时间、更新时间、元数据缓存时间
- **表信息 (TableInfo)**: 表示数据库中的表或视图，包含 schema 名称、表名、表类型、列列表
- **列信息 (ColumnInfo)**: 表示表中的列，包含列名、数据类型、是否可空、默认值、是否主键、是否外键
- **查询请求 (QueryRequest)**: 表示用户的查询请求，包含 SQL 语句
- **查询结果 (QueryResult)**: 表示查询执行结果，包含列名列表、数据行、行数、执行时间
- **自然语言查询 (NaturalLanguageQuery)**: 表示用户的自然语言查询，包含提示文本
- **测试数据库架构 (TestDatabaseSchema)**: 电商业务领域的测试数据库，包含以下表：用户表 (users)、产品表 (products)、订单表 (orders, 1000+ 条记录)、支付表 (payments)、评价表 (reviews)，用于验证多表关联、聚合查询等场景

## 成功标准 *(必填)*

### 可衡量成果

- **SC-001**: 用户可以在 30 秒内成功添加并验证 MySQL 数据库连接
- **SC-002**: 系统能在 10 秒内完成包含 100 张表的数据库的元数据提取
- **SC-003**: 简单查询（无复杂联接）在 2 秒内返回结果
- **SC-004**: 自然语言生成的 SQL 查询中 90% 能正确执行（无语法错误）
- **SC-005**: 测试数据库创建脚本能在 1 分钟内完成数据库和测试数据的创建
- **SC-006**: 系统能正确处理并显示包含 1000 条以上记录的查询结果
- **SC-007**: 用户界面不需要任何修改即可支持 MySQL 连接（后端变更透明）

## 澄清记录

### Session 2025-12-16

- Q: 测试数据库应采用什么业务领域？ → A: 电商系统 (用户、产品、订单、支付、评价)

## 假设

- MySQL 服务已安装且正在运行
- 可以通过 `mysql -u root` 无密码访问数据库（开发/测试环境配置）
- MySQL 版本为 5.7 或更高版本（支持 information_schema）
- 现有的 SQLite 缓存机制可以扩展支持 MySQL 元数据
- 现有的前端界面可以无修改支持新的数据库类型
- aiomysql 或类似的异步 MySQL 驱动可用于 Python
